{% assign collection_group = products | map: 'id' %}
{% assign collection_group_thumb = collection_group | append : 'thumb' %}
{% assign collection_group_mobile = collection_group | append : 'mobile' %}

{% if related_products == true %}
  {% assign hover_enabled = block.settings.show_related_products_title_on_hover %}
{% else %}
  {% assign hover_enabled = settings.thumbnail_hover_enabled %}
{% endif %}

{% if related_products == true %}
  {% assign related_items = true %}
{% else %}
  {% assign related_items = false %}
{% endif %}

{% assign for_limit = limit %}

{% comment %} loop through product list {% endcomment %}
{% for product in products limit: limit %}

  {% comment %} if product display is in the loop of products increase limit by one {% endcomment %}
  {% if product.id == skip_product.id  %}
    {% assign for_limit = limit | plus: 1 %}
  {% endif %}
{% endfor %}

{% for product in products limit: for_limit %}

  {% comment %} Skip product if we're on its product page {% endcomment %}
  {% if product.id != skip_product.id %}
    {% include 'product-thumbnail', related_products: related_items %}
  {% endif %}
{% endfor %}

{% comment %} JSON-LD Structured data - https://developers.google.com/search/docs/guides/intro-structured-data {% endcomment %}
{% unless context == 'product_recommendations' %}
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "OfferCatalog",
      "itemListElement": [
        {% for product in products limit: for_limit %}
          {
            "@type": "Product",
            "url": "{{ shop.url }}{{ product.url }}",
            "name": "{{ product.title }}",
            "mpn": "{{ product.id }}",
            "brand": {
              "@type": "Thing",
              "name": "{{ product.vendor }}"
            },
            "offers": {
              "@type": "Offer",
              "priceCurrency": "{{ shop.currency }}",
              "price": "{{ product.selected_or_first_available_variant.price | money_without_currency | remove: "," }}",
              "availability": "{% if product.available %}InStock{% else %}OutOfStock{% endif %}",
              "priceValidUntil": "{{ 'now' | date: '%s' | plus: 31536000 | date: '%Y-%m-%d' | uri_encode | replace:'+','%20' }}",
              "url": "{{ shop.url }}{{ product.url }}",
              "seller": {
                "@type": "Organization",
                "name": "{{ shop.name }}"
              }
            },
            "description": "{{ product.description | strip_html | strip | escape }}",
            "image": "https:{{ product.featured_image | product_img_url: '450x450' }}"
            {%- if product.first_available_variant.sku != blank -%}
              ,"sku": "{{ product.first_available_variant.sku }}"
            {%- endif -%}
            {% if product.metafields.okendo.summaryData.reviewCount > 0 %}
            ,"aggregateRating": {
              "@type": "AggregateRating",
              "ratingValue": "{{ product.metafields.okendo.summaryData.reviewAverageValue }}",
              "ratingCount": "{{ product.metafields.okendo.summaryData.reviewCount }}"
            }
            {% elsif product.metafields.okendo.ReviewCount > 0 %}
            ,"aggregateRating": {
              "@type": "AggregateRating",
              "ratingValue": "{{ product.metafields.okendo.ReviewAverageValue }}",
              "ratingCount": "{{ product.metafields.okendo.ReviewCount }}"
            }
            {% endif %}
          } {%- unless forloop.last -%},{%- endunless -%}
        {% endfor %}
      ]
    }
  </script>
{% endunless %}
